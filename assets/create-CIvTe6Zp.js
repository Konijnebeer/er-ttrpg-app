import{r as j,j as e,Q as N,F as T,U as Be,D as Ke,I as Le,G as pe,P as B,N as W,K as H,M as ze,V as qe,W as E,u as P,Y as w,T as ge,a as xe,d as Fe,Z as K,_ as $,$ as He,a0 as Ue,a1 as We,a2 as Ye,a3 as Xe,a4 as Qe,a5 as Ze,y as Je,m as et,a6 as tt,t as st,n as re,a7 as q,a8 as rt,A as at,b as nt,c as ae,e as it,f as ot,g as lt,h as dt,i as ct,k as ut,l as ht,z as k,a9 as ne,aa as M,ab as G,ac as mt}from"./index-D102p7gL.js";import{e as ie,m as ft,D as pt,g as oe,f as gt,h as xt,u as Ft,a as I,b as y,c as V,i as L,j as je,F as le}from"./useForm-CQIqvnPD.js";import{T as jt,c as ve,R as vt,I as Ct,u as bt,a as Ce,C as Y,S as X,b as Q,d as Z,e as J,f as ee,m as de,g as St,h as kt,i as ce,j as ue}from"./tabs-BVIeQ9QR.js";import{C as yt,I as be,a as Se,b as ke,c as ye,d as we}from"./item-B8o5h-cK.js";import"./chevron-down-I8hV6sYI.js";class _{constructor(r){if(this.getFormFieldName=s=>{if(typeof this.fieldsMap=="string")return ie(this.fieldsMap,s);const t=ft(s)[0];if(typeof t!="string")return"";const a=s.slice(t.length),n=this.fieldsMap[t];return ie(n,a)},this.getFormFieldOptions=s=>{const t={...s},a=t.validators;if(t.name=this.getFormFieldName(s.name),a&&(a.onChangeListenTo||a.onBlurListenTo)){const n={...a},i=c=>{if(c)return c.map(m=>this.getFormFieldName(m))};n.onChangeListenTo=i(a.onChangeListenTo),n.onBlurListenTo=i(a.onBlurListenTo),t.validators=n}return t},this.mount=()=>this.store.mount(),this.validateArrayFieldsStartingFrom=async(s,t,a)=>this.form.validateArrayFieldsStartingFrom(this.getFormFieldName(s),t,a),this.validateField=(s,t)=>this.form.validateField(this.getFormFieldName(s),t),this.getFieldValue=s=>this.form.getFieldValue(this.getFormFieldName(s)),this.getFieldMeta=s=>this.form.getFieldMeta(this.getFormFieldName(s)),this.setFieldMeta=(s,t)=>this.form.setFieldMeta(this.getFormFieldName(s),t),this.setFieldValue=(s,t,a)=>this.form.setFieldValue(this.getFormFieldName(s),t,a),this.deleteField=s=>this.form.deleteField(this.getFormFieldName(s)),this.pushFieldValue=(s,t,a)=>this.form.pushFieldValue(this.getFormFieldName(s),t,a),this.insertFieldValue=async(s,t,a,n)=>this.form.insertFieldValue(this.getFormFieldName(s),t,a,n),this.replaceFieldValue=async(s,t,a,n)=>this.form.replaceFieldValue(this.getFormFieldName(s),t,a,n),this.removeFieldValue=async(s,t,a)=>this.form.removeFieldValue(this.getFormFieldName(s),t,a),this.swapFieldValues=(s,t,a,n)=>this.form.swapFieldValues(this.getFormFieldName(s),t,a,n),this.moveFieldValues=(s,t,a,n)=>this.form.moveFieldValues(this.getFormFieldName(s),t,a,n),this.clearFieldValues=(s,t)=>this.form.clearFieldValues(this.getFormFieldName(s),t),this.resetField=s=>this.form.resetField(this.getFormFieldName(s)),this.validateAllFields=s=>this.form.validateAllFields(s),r.form instanceof _){const s=r.form;if(this.form=s.form,typeof r.fields=="string")this.fieldsMap=s.getFormFieldName(r.fields);else{const t={...r.fields};for(const a in t)t[a]=s.getFormFieldName(t[a]);this.fieldsMap=t}}else this.form=r.form,this.fieldsMap=r.fields;this.store=new pt({deps:[this.form.store],fn:({currDepVals:s})=>{const t=s[0];let a;if(typeof this.fieldsMap=="string")a=oe(t.values,this.fieldsMap);else{a={};const n=this.fieldsMap;for(const i in n)a[i]=oe(t.values,n[i])}return{values:a}}})}get state(){return this.store.state}async handleSubmit(r){return this.form.handleSubmit(r)}}function wt({lens:o,selector:r,children:s}){const t=N(o.store,r);return e.jsx(e.Fragment,{children:xt(s,t)})}function Rt(o){const[r]=j.useState(()=>{const s=new _(o),t=o.form instanceof _?o.form.form:o.form,a=s;return a.AppForm=function(i){return e.jsx(t.AppForm,{...i})},a.AppField=function(i){return e.jsx(t.AppField,{...r.getFormFieldOptions(i)})},a.Field=function(i){return e.jsx(t.Field,{...r.getFormFieldOptions(i)})},a.Subscribe=function(i){return e.jsx(wt,{lens:r,selector:i.selector,children:i.children})},Object.assign(a,{...o.formComponents})});return gt(r.mount,[r]),r}const he=j.createContext(null),me=j.createContext(null);function At(){function o(){const s=j.useContext(he);if(!s)throw new Error("`fieldContext` only works when within a `fieldComponent` passed to `createFormHook`");return s}function r(){const s=j.useContext(me);if(!s)throw new Error("`formContext` only works when within a `formComponent` passed to `createFormHook`");return s}return{fieldContext:he,useFieldContext:o,useFormContext:r,formContext:me}}function Et({fieldComponents:o,fieldContext:r,formContext:s,formComponents:t}){function a(c){const m=Ft(c),h=j.useMemo(()=>({children:l})=>e.jsx(s.Provider,{value:m,children:l}),[m]),p=j.useMemo(()=>(({children:C,...d})=>e.jsx(m.Field,{...d,children:x=>e.jsx(r.Provider,{value:x,children:C(Object.assign(x,o))})})),[m]);return j.useMemo(()=>Object.assign(m,{AppField:p,AppForm:h,...t}),[m,p,h])}function n({render:c,props:m}){return h=>c({...m,...h})}function i({render:c,props:m,defaultValues:h}){return function(g){const l=j.useMemo(()=>({form:g.form,fields:g.fields,defaultValues:h,formComponents:t}),[g.form,g.fields]),C=Rt(l);return c({...m,...g,group:C})}}return{useAppForm:a,withForm:n,withFieldGroup:i}}function Nt({className:o,...r}){return e.jsx("div",{"data-slot":"input-group",role:"group",className:T("group/input-group border-input dark:bg-input/30 relative flex w-full items-center rounded-md border shadow-xs transition-[color,box-shadow] outline-none","h-9 min-w-0 has-[>textarea]:h-auto","has-[>[data-align=inline-start]]:[&>input]:pl-2","has-[>[data-align=inline-end]]:[&>input]:pr-2","has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3","has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3","has-[[data-slot=input-group-control]:focus-visible]:border-ring has-[[data-slot=input-group-control]:focus-visible]:ring-ring/50 has-[[data-slot=input-group-control]:focus-visible]:ring-[3px]","has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40",o),...r})}const Vt=Be("text-muted-foreground flex h-auto cursor-text items-center justify-center gap-2 py-1.5 text-sm font-medium select-none [&>svg:not([class*='size-'])]:size-4 [&>kbd]:rounded-[calc(var(--radius)-5px)] group-data-[disabled=true]/input-group:opacity-50",{variants:{align:{"inline-start":"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]","inline-end":"order-last pr-3 has-[>button]:mr-[-0.45rem] has-[>kbd]:mr-[-0.35rem]","block-start":"order-first w-full justify-start px-3 pt-3 [.border-b]:pb-3 group-has-[>input]/input-group:pt-2.5","block-end":"order-last w-full justify-start px-3 pb-3 [.border-t]:pt-3 group-has-[>input]/input-group:pb-2.5"}},defaultVariants:{align:"inline-start"}});function Ot({className:o,align:r="inline-start",...s}){return e.jsx("div",{role:"group","data-slot":"input-group-addon","data-align":r,className:T(Vt({align:r}),o),onClick:t=>{t.target.closest("button")||t.currentTarget.parentElement?.querySelector("input")?.focus()},...s})}function Pt({className:o,...r}){return e.jsx("span",{className:T("text-muted-foreground flex items-center gap-2 text-sm [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",o),...r})}function Tt({className:o,...r}){return e.jsx(jt,{"data-slot":"input-group-control",className:T("flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent",o),...r})}var te="Radio",[It,Re]=pe(te),[Dt,Mt]=It(te),Ae=j.forwardRef((o,r)=>{const{__scopeRadio:s,name:t,checked:a=!1,required:n,disabled:i,value:c="on",onCheck:m,form:h,...p}=o,[g,l]=j.useState(null),C=W(r,v=>l(v)),d=j.useRef(!1),x=g?h||!!g.closest("form"):!0;return e.jsxs(Dt,{scope:s,checked:a,disabled:i,children:[e.jsx(B.button,{type:"button",role:"radio","aria-checked":a,"data-state":Oe(a),"data-disabled":i?"":void 0,disabled:i,value:c,...p,ref:C,onClick:H(o.onClick,v=>{a||m?.(),x&&(d.current=v.isPropagationStopped(),d.current||v.stopPropagation())})}),x&&e.jsx(Ve,{control:g,bubbles:!d.current,name:t,value:c,checked:a,required:n,disabled:i,form:h,style:{transform:"translateX(-100%)"}})]})});Ae.displayName=te;var Ee="RadioIndicator",Ne=j.forwardRef((o,r)=>{const{__scopeRadio:s,forceMount:t,...a}=o,n=Mt(Ee,s);return e.jsx(ze,{present:t||n.checked,children:e.jsx(B.span,{"data-state":Oe(n.checked),"data-disabled":n.disabled?"":void 0,...a,ref:r})})});Ne.displayName=Ee;var Gt="RadioBubbleInput",Ve=j.forwardRef(({__scopeRadio:o,control:r,checked:s,bubbles:t=!0,...a},n)=>{const i=j.useRef(null),c=W(i,n),m=bt(s),h=qe(r);return j.useEffect(()=>{const p=i.current;if(!p)return;const g=window.HTMLInputElement.prototype,C=Object.getOwnPropertyDescriptor(g,"checked").set;if(m!==s&&C){const d=new Event("click",{bubbles:t});C.call(p,s),p.dispatchEvent(d)}},[m,s,t]),e.jsx(B.input,{type:"radio","aria-hidden":!0,defaultChecked:s,...a,tabIndex:-1,ref:c,style:{...a.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});Ve.displayName=Gt;function Oe(o){return o?"checked":"unchecked"}var $t=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],z="RadioGroup",[_t]=pe(z,[ve,Re]),Pe=ve(),Te=Re(),[Bt,Kt]=_t(z),Ie=j.forwardRef((o,r)=>{const{__scopeRadioGroup:s,name:t,defaultValue:a,value:n,required:i=!1,disabled:c=!1,orientation:m,dir:h,loop:p=!0,onValueChange:g,...l}=o,C=Pe(s),d=Ke(h),[x,v]=Le({prop:n,defaultProp:a??null,onChange:g,caller:z});return e.jsx(Bt,{scope:s,name:t,required:i,disabled:c,value:x,onValueChange:v,children:e.jsx(vt,{asChild:!0,...C,orientation:m,dir:d,loop:p,children:e.jsx(B.div,{role:"radiogroup","aria-required":i,"aria-orientation":m,"data-disabled":c?"":void 0,dir:d,...l,ref:r})})})});Ie.displayName=z;var De="RadioGroupItem",Me=j.forwardRef((o,r)=>{const{__scopeRadioGroup:s,disabled:t,...a}=o,n=Kt(De,s),i=n.disabled||t,c=Pe(s),m=Te(s),h=j.useRef(null),p=W(r,h),g=n.value===a.value,l=j.useRef(!1);return j.useEffect(()=>{const C=x=>{$t.includes(x.key)&&(l.current=!0)},d=()=>l.current=!1;return document.addEventListener("keydown",C),document.addEventListener("keyup",d),()=>{document.removeEventListener("keydown",C),document.removeEventListener("keyup",d)}},[]),e.jsx(Ct,{asChild:!0,...c,focusable:!i,active:g,children:e.jsx(Ae,{disabled:i,required:n.required,checked:g,...m,...a,name:n.name,ref:p,onCheck:()=>n.onValueChange(a.value),onKeyDown:H(C=>{C.key==="Enter"&&C.preventDefault()}),onFocus:H(a.onFocus,()=>{l.current&&h.current?.click()})})})});Me.displayName=De;var Lt="RadioGroupIndicator",Ge=j.forwardRef((o,r)=>{const{__scopeRadioGroup:s,...t}=o,a=Te(s);return e.jsx(Ne,{...a,...t,ref:r})});Ge.displayName=Lt;var zt=Ie,qt=Me,Ht=Ge;function $e({className:o,...r}){return e.jsx(zt,{"data-slot":"radio-group",className:T("grid gap-3",o),...r})}function U({className:o,...r}){return e.jsx(qt,{"data-slot":"radio-group-item",className:T("border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",o),...r,children:e.jsx(Ht,{"data-slot":"radio-group-indicator",className:"relative flex items-center justify-center",children:e.jsx(yt,{className:"fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2"})})})}function Ut({label:o}){const r=D(),s=r.state.meta.isTouched&&!r.state.meta.isValid;return e.jsxs(I,{"data-invalid":s,children:[e.jsx(y,{htmlFor:r.name,children:o}),e.jsx(Ce,{id:r.name,name:r.name,value:r.state.value,onBlur:r.handleBlur,onChange:t=>r.handleChange(t.target.value),"aria-invalid":s,placeholder:"Character name",autoComplete:"off"}),s&&e.jsx(V,{errors:r.state.meta.errors})]})}function Wt({label:o}){const r=D(),s=r.state.meta.isTouched&&!r.state.meta.isValid;return e.jsxs(I,{"data-invalid":s,children:[e.jsx(y,{htmlFor:r.name,children:o}),e.jsx(Ce,{id:r.name,name:r.name,value:r.state.value,onBlur:r.handleBlur,onChange:t=>r.handleChange(t.target.value),"aria-invalid":s,placeholder:"Username",autoComplete:"off"}),s&&e.jsx(V,{errors:r.state.meta.errors})]})}function Yt({label:o,maxCharacters:r}){const s=D(),t=s.state.meta.isTouched&&!s.state.meta.isValid;return e.jsxs(I,{"data-invalid":t,children:[e.jsx(y,{htmlFor:s.name,children:o}),e.jsxs(Nt,{children:[e.jsx(Tt,{id:s.name,name:s.name,value:s.state.value,onBlur:s.handleBlur,onChange:a=>s.handleChange(a.target.value),placeholder:"Place to add any information about the character or build",rows:5,className:"min-h-12 resize-none","aria-invalid":t}),e.jsx(Ot,{align:"block-end",children:e.jsxs(Pt,{className:"tabular-nums",children:[s.state.value.length,"/",r," characters"]})})]}),t&&e.jsx(V,{errors:s.state.meta.errors})]})}function Xt({label:o}){const r=D(),s=r.state.meta.isTouched&&!r.state.meta.isValid;return e.jsxs(I,{"data-invalid":s,children:[e.jsx(y,{children:o}),e.jsxs($e,{name:r.name,value:r.state.value,onValueChange:t=>r.handleChange(t),className:"flex gap-4 flex-wrap",children:[e.jsxs(y,{htmlFor:"newly-awakened",className:"flex items-center gap-2 cursor-pointer p-2 rounded-md border",children:[e.jsx(U,{value:E.enum.newly,id:"newly-awakened"}),e.jsx("span",{children:"Newly-Awakened"})]}),e.jsxs(y,{htmlFor:"capable-explorer",className:"flex items-center gap-2 cursor-pointer p-2 rounded-md border",children:[e.jsx(U,{value:E.enum.capable,id:"capable-explorer"}),e.jsx("span",{children:"Capable Explorer"})]})]}),s&&e.jsx(V,{errors:r.state.meta.errors})]})}function Qt({originId:o,sourceKey:r,entityRefs:s,type:t,parentType:a,label:n}){const i=D(),c=_e(),m=N(c.store,u=>u.values.wandererExperience);let h=[];t==="edges"&&a==="origins"?h=N(c.store,u=>u.values.selectedPathEdges):t==="edges"&&a==="paths"&&(h=N(c.store,u=>u.values.selectedOriginEdges));const{resolveRefrence:p}=P(),[g,l]=j.useState([]),C=i.state.meta.isTouched&&!i.state.meta.isValid,d=i.state.value||[];let x=1;m===E.enum.newly?(t==="edges"&&(x=1),t==="skills"&&(x=2),(t==="oddements"||t==="fragments")&&(x=1)):m===E.enum.capable&&(t==="edges"&&(x=1),t==="skills"&&(x=4),(t==="oddements"||t==="fragments")&&(x=2)),j.useEffect(()=>{l([]);const u=[];s.forEach(f=>{try{const S=p(w(r,f),t);S&&u.push(S)}catch(S){console.error(`Failed to resolve reference: ${f}`,S)}}),l(u)},[o,r,s,p]);const v=(u,f)=>{const S=w(r,u);if(t==="oddements"||t==="fragments"){let R;R=d,f?R.some(F=>F.ref===S)||i.handleChange([...R,{ref:S,quantity:1}]):i.handleChange(R.filter(F=>F.ref!==S));return}const A=d;f?A.includes(S)||i.handleChange([...A,S]):i.handleChange(A.filter(R=>R!==S))};return e.jsxs(L,{"data-invalid":C,children:[e.jsxs(y,{children:[n," (",d.length," of ",x||"X"," selected)"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:g.map(u=>{const f=w(r,u.id),S=t==="oddements"||t==="fragments"?d.some(b=>b.ref===f):d.includes(f),R=t==="edges"&&h.includes(f)||!S&&d.length>=x&&x!==1/0,F=e.jsxs(y,{htmlFor:`${a}-${t}-${u.id}`,children:[e.jsx(Y,{id:`${a}-${t}-${u.id}`,checked:S,disabled:R,onCheckedChange:b=>v(u.id,b)}),u.name]});return e.jsx(I,{children:u.description?e.jsxs(ge,{children:[e.jsx(xe,{asChild:!0,children:F}),e.jsx(Fe,{className:"[&_svg]:hidden!",sideOffset:8,children:u.description})]}):F},`${a}-${t}-${u.id}`)})}),C&&e.jsx(V,{errors:i.state.meta.errors})]})}function Zt({originId:o,sourceKey:r,aspectRefs:s}){const t=D(),a=_e(),n=N(a.store,d=>d.values.wandererExperience),{resolveRefrence:i,isLoading:c}=P(),[m,h]=j.useState([]),p=t.state.meta.isTouched&&!t.state.meta.isValid,g=t.state.value||[];let l=1;n===E.enum.newly?l=1:n===E.enum.capable&&(l=2),j.useEffect(()=>{h([]);const d=[];s.forEach(x=>{try{const v=i(w(r,x),"aspects");v&&d.push(v)}catch(v){console.error(`Failed to resolve reference: ${x}`,v)}}),h(d)},[o,r,s,i]);const C=(d,x)=>{const v=w(r,d),f=m.find(A=>A.id===d)?.maxTrack??0,S={ref:v,track:f};x?g.length<l&&t.handleChange([...g,S]):t.handleChange(g.filter(A=>A.ref!==v))};return c?e.jsx("div",{children:"Loading..."}):e.jsxs(L,{"data-invalid":p,children:[e.jsxs(y,{children:["Aspects (",g.length," of ",l," selected)"]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-2",children:m.map(d=>{const x=w(r,d.id),v=g.some(f=>f.ref===x),u=!v&&g.length>=l;return e.jsxs(I,{children:[e.jsxs(ge,{children:[e.jsx(xe,{asChild:!0,children:e.jsxs(y,{htmlFor:`aspect-${d.id}`,children:[e.jsx(Y,{id:`aspect-${d.id}`,checked:v,disabled:u,onCheckedChange:f=>C(d.id,f)}),d.name,e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",d.maxTrack," Track ",d.category,")"]})]})}),e.jsx(Fe,{className:"[&_svg]:hidden!",sideOffset:8,children:d.description})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Effect:"})," ",d.effect]})]},d.id)})}),p&&e.jsx(V,{errors:t.state.meta.errors})]})}const{fieldContext:Jt,useFieldContext:D,formContext:es,useFormContext:_e}=At(),{useAppForm:ts,withForm:se}=Et({fieldContext:Jt,formContext:es,fieldComponents:{NameField:Ut,AuthorField:Wt,DescriptionField:Yt,WandererExperienceField:Xt,EdgesSkillsField:Qt,AspectsField:Zt},formComponents:{}}),ss=se({defaultValues:K,render:function({form:r}){const{groupedSources:s}=P();return e.jsx(r.AppField,{name:"versionRef",listeners:{onChange:()=>{r.setFieldValue("data.character.originRef",""),r.setFieldValue("data.character.pathRef","")}},children:t=>{const a=t.state.meta.isTouched&&!t.state.meta.isValid;return e.jsxs(L,{"data-invalid":a,children:[e.jsx(y,{htmlFor:"versionRef",children:"Core Dependencies"}),e.jsx(je,{children:"Select the core content the character will use"}),e.jsx($e,{value:t.state.value,onValueChange:n=>t.handleChange(n),"aria-invalid":a,children:s.Core.map(n=>e.jsx(rs,{sourceId:n.id,versions:n.versions,onSelect:i=>t.handleChange(i)},n.id))}),a&&e.jsx(V,{errors:t.state.meta.errors})]})}})}});function rs({sourceId:o,versions:r,onSelect:s}){const[t,a]=j.useState(r[0]),n=c=>{a(c);const m=$(o,c);s(m)},i=$(o,t);return e.jsx(y,{htmlFor:o,className:"w-full",children:e.jsxs(be,{variant:"outline",size:"sm",className:"w-full",children:[e.jsx(Se,{children:e.jsx(U,{value:i,id:o})}),e.jsx(ke,{children:e.jsx(ye,{children:o})}),e.jsx(we,{children:e.jsxs(X,{value:t,onValueChange:n,children:[e.jsx(Q,{className:"w-[120px]",children:e.jsx(Z,{placeholder:"Select a Version"})}),e.jsx(J,{children:r.map(c=>e.jsx(ee,{value:c,children:c},c))})]})})]})})}const as=se({defaultValues:K,render:function({form:r}){const{groupedSources:s}=P();return e.jsx(r.Subscribe,{selector:t=>t.values.versionRef,children:t=>t&&e.jsx(r.Field,{name:"dependencies",children:a=>e.jsxs(L,{children:[e.jsx(y,{children:"Extra Content"}),e.jsx(je,{children:"Select additional content for this character"}),s.Extra.map(n=>e.jsx(ns,{sourceId:n.id,versions:n.versions,selectedKeys:a.state.value||[],onToggle:(i,c)=>{const m=a.state.value||[];c?a.handleChange([...m,i]):a.handleChange(m.filter(h=>h!==i))}},n.id))]})})})}});function ns({sourceId:o,versions:r,selectedKeys:s,onToggle:t}){const[a,n]=j.useState(r[0]),i=$(o,a),c=s.includes(i),m=p=>{const g=i,l=$(o,p);c&&(t(g,!1),t(l,!0)),n(p)},h=p=>{t(i,p)};return e.jsx(y,{htmlFor:o,className:"w-full",children:e.jsxs(be,{variant:"outline",size:"sm",className:"w-full",children:[e.jsx(Se,{children:e.jsx(Y,{checked:c,onCheckedChange:h,id:o})}),e.jsx(ke,{children:e.jsx(ye,{children:o})}),e.jsx(we,{children:e.jsxs(X,{value:a,onValueChange:m,children:[e.jsx(Q,{className:"w-[180px]",children:e.jsx(Z,{placeholder:"Select a Version"})}),e.jsx(J,{children:r.map(p=>e.jsx(ee,{value:p,children:p},p))})]})})]})})}const fe=se({defaultValues:K,props:{sourceKeys:[],type:"",label:""},render:function({form:r,sourceKeys:s,type:t,label:a}){const{sources:n,getSourceDataArray:i}=P(),[c,m]=j.useState([]);j.useEffect(()=>{if(s.length>0&&n.size>0){const x=[];s.forEach(v=>{const u=i(v,t);u&&u.forEach(f=>{x.push({sourceKey:v,data:f})})}),m(x)}},[s,i]);let h="data.character.originRef",p="selectedOriginEdges",g="selectedOriginSkills",l="selectedOriginOddements",C="selectedOriginFragments",d="selectedOriginAspects";return t==="paths"&&(h="data.character.pathRef",p="selectedPathEdges",g="selectedPathSkills",l="selectedPathOddements",C="selectedPathFragments",d="selectedPathAspects"),e.jsx(r.Field,{name:h,listeners:{onChange:()=>{r.setFieldValue(p,[]),r.setFieldValue(g,[]),r.setFieldValue(l,[]),r.setFieldValue(C,[]),r.setFieldValue(d,[])}},children:x=>{const v=x.state.value,u=c.find(f=>w(f.sourceKey,f.data.id)===v);return e.jsx(y,{htmlFor:"origin-select",className:"w-full",children:e.jsxs(He,{className:"w-full",children:[e.jsxs(Ue,{children:[e.jsx(We,{children:a}),e.jsxs(Ye,{children:["Select an ",a]}),e.jsx(Xe,{children:c.length===0?"No origins available":e.jsxs(X,{value:x.state.value,onValueChange:f=>x.handleChange(f),children:[e.jsx(Q,{className:"w-[180px]",children:e.jsx(Z,{placeholder:`Select an ${a}`})}),e.jsx(J,{children:c.map(f=>e.jsx(ee,{value:w(f.sourceKey,f.data.id),children:f.data.name},`${f.sourceKey}-${f.data.id}`))})]})})]}),e.jsxs(Qe,{children:[u&&e.jsx("p",{className:"pb-2 -mt-4 whitespace-pre-line",children:u.data.description}),u?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-4",children:[e.jsx(r.AppField,{name:p,children:f=>e.jsx(f.EdgesSkillsField,{originId:u.data.id,sourceKey:u.sourceKey,entityRefs:u.data.edges,type:"edges",parentType:t,label:"Edges"})}),e.jsx(r.AppField,{name:g,children:f=>e.jsx(f.EdgesSkillsField,{originId:u.data.id,sourceKey:u.sourceKey,entityRefs:u.data.skills,type:"skills",parentType:t,label:"Skills"})}),e.jsx(r.AppField,{name:l,children:f=>e.jsx(f.EdgesSkillsField,{originId:u.data.id,sourceKey:u.sourceKey,entityRefs:u.data.oddements,type:"oddements",parentType:t,label:"Oddements"})}),e.jsx(r.AppField,{name:C,children:f=>e.jsx(f.EdgesSkillsField,{originId:u.data.id,sourceKey:u.sourceKey,entityRefs:u.data.fragments,type:"fragments",parentType:t,label:"Fragments"})})]}),e.jsx(r.AppField,{name:d,children:f=>e.jsx(f.AspectsField,{originId:u.data.id,sourceKey:u.sourceKey,aspectRefs:u.data.aspects})})]}):`No ${a} selected`]}),e.jsx(Ze,{children:e.jsx(V,{errors:x.state.meta.errors})})]})})}})}});function is(){const{loadSources:o,resolveRefrence:r,getSourceDataArray:s}=P(),{createNewCharacter:t}=Je();return{createCharacter:async({value:n})=>{const i=n.versionRef,c=n.dependencies,m=[i,...c??[]].filter(Boolean);try{await o(m);const h=r(n.data.character.originRef,"origins"),p=r(n.data.character.pathRef,"paths");if(!h||!p)throw Error("cant find origin");const g=h.gaugeBonuses.fallout+p.gaugeBonuses.fallout,l=h.gaugeBonuses.curse+p.gaugeBonuses.curse,d=[...(s(i,"edges")??[]).map(F=>({ref:w(i,F.id),sourceKey:i,id:F.id})),...c.flatMap(F=>(s(F,"edges")??[]).map(b=>({ref:w(F,b.id),sourceKey:F,id:b.id})))].map(F=>({ref:F.ref,level:0}));n.selectedOriginEdges.forEach(F=>{const b=d.find(O=>O.ref===F);b&&(b.level+=1)}),n.selectedPathEdges.forEach(F=>{const b=d.find(O=>O.ref===F);b&&(b.level+=1)});const v=[...(s(i,"skills")??[]).map(F=>({ref:w(i,F.id),sourceKey:i,id:F.id})),...c.flatMap(F=>(s(F,"skills")??[]).map(b=>({ref:w(F,b.id),sourceKey:F,id:b.id})))].map(F=>({ref:F.ref,level:0}));n.selectedOriginSkills.forEach(F=>{const b=v.find(O=>O.ref===F);b&&(b.level+=1)}),n.selectedPathSkills.forEach(F=>{const b=v.find(O=>O.ref===F);b&&(b.level+=1)});const u=F=>r(F,"oddements")?.tags,f=de([...n.selectedOriginOddements,...n.selectedPathOddements],u),S=de([...n.selectedOriginFragments,...n.selectedPathFragments]),A=[...n.selectedOriginAspects,...n.selectedPathAspects],R={id:n.id,name:n.name,description:n.description,author:n.author,sheetVersion:n.sheetVersion,dateCreated:n.dateCreated,dateModified:n.dateModified,versionRef:n.versionRef,dependencies:n.dependencies,data:{character:{name:n.name,player:n.author,pronouns:"",origin:h.name,originRef:n.data.character.originRef,path:p.name,pathRef:n.data.character.pathRef,milestones:0,dispair:n.wandererExperience===E.enum.newly?0:1,hope:n.wandererExperience===E.enum.newly?2:1,fallout:{level:0,condition:"",maxTrack:g,currentTrack:0},curse:{level:0,condition:"",maxTrack:l,currentTrack:0},clock:{food:0,sleep:0,dawnDusk:0}},edges:d,skills:v,backpack:{oddements:f,fragments:S,campingGear:[]},aspects:A}};return await t(R),!0}catch(h){throw console.error("Failed to create character:",h),h}}}}const os=tt.pick({id:!0,name:!0,description:!0,author:!0,sheetVersion:!0,dateCreated:!0,dateModified:!0,versionRef:!0}).extend({dependencies:k.array(mt),data:k.object({character:k.object({originRef:k.string().nonempty("Origin is required"),pathRef:k.string().nonempty("Path is required")})}),selectedOriginEdges:k.array(G).min(1).max(2),selectedOriginSkills:k.array(G).min(2).max(4),selectedOriginOddements:k.array(M).min(1).max(2),selectedOriginFragments:k.array(M).min(1).max(2),selectedOriginAspects:k.array(ne).min(1).max(2),selectedPathEdges:k.array(G).min(1).max(2),selectedPathSkills:k.array(G).min(2).max(4),selectedPathOddements:k.array(M).min(1).max(2),selectedPathFragments:k.array(M).min(1).max(2),selectedPathAspects:k.array(ne).min(1).max(2),wandererExperience:E});function ms(){const{createCharacter:o}=is(),r=et(),{loadAllSourcesMetadata:s,loadSources:t,isLoading:a,error:n}=P();j.useEffect(()=>{s()},[s]);const i=ts({defaultValues:K,validators:{onSubmit:os},onSubmit:async({value:l})=>{st.promise(o({value:l}),{loading:"Creating character...",success:()=>(r({to:"/characters/$characterId/preview",params:{characterId:l.id}}),`Created character: ${l.name}`),error:`Failed to create character: ${l.name}`})}}),c=N(i.store,l=>l.values.versionRef),m=N(i.store,l=>l.values.dependencies),h=[c,...m??[]].filter(l=>l!=="");j.useEffect(()=>{h.length>0&&t(h)},[c,m,t]);const p=N(i.store,l=>l.values.data.character.originRef),g=N(i.store,l=>l.values.data.character.pathRef);return a?e.jsx(re,{children:"Loading..."}):n?e.jsx("div",{children:n}):e.jsx(re,{className:"p-4",children:e.jsxs(q,{className:"h-full w-full lg:h-auto lg:overflow-visible",children:[e.jsx(rt,{orientation:"vertical"}),e.jsxs("form",{id:"create-character",onSubmit:l=>{l.preventDefault(),i.handleSubmit()},className:"flex flex-col lg:flex-row gap-4 p-2",children:[e.jsxs(le,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx(i.AppField,{name:"name",children:l=>e.jsx(l.NameField,{label:"Name"})}),e.jsx(i.AppField,{name:"author",children:l=>e.jsx(l.AuthorField,{label:"Author"})})]}),e.jsx(i.AppField,{name:"wandererExperience",listeners:{onChange:l=>{l.value===E.enum.newly&&(i.setFieldValue("selectedOriginEdges",[]),i.setFieldValue("selectedOriginSkills",[]),i.setFieldValue("selectedOriginOddements",[]),i.setFieldValue("selectedOriginFragments",[]),i.setFieldValue("selectedOriginAspects",[]),i.setFieldValue("selectedPathEdges",[]),i.setFieldValue("selectedPathSkills",[]),i.setFieldValue("selectedPathOddements",[]),i.setFieldValue("selectedPathFragments",[]),i.setFieldValue("selectedPathAspects",[]))}},children:l=>e.jsx(l.WandererExperienceField,{label:"Wanderer Experience"})}),e.jsx(i.AppField,{name:"description",children:l=>e.jsx(l.DescriptionField,{label:"Description",maxCharacters:200})}),e.jsx(i.Subscribe,{selector:l=>l.values.versionRef,children:l=>l&&e.jsx(i.AppForm,{children:e.jsxs(St,{defaultValue:"origin",className:"mb-4",children:[e.jsxs(kt,{children:[e.jsx(ce,{value:"origin",children:"Origin"}),e.jsx(ce,{value:"path",children:"Path"})]}),e.jsx(ue,{value:"origin",children:e.jsx(q,{className:`${p?"h-[75vh]":"h-[22vh]"} lg:h-[48vh] overflow-hidden`,children:e.jsx(fe,{form:i,sourceKeys:h,type:"origins",label:"Origin"})})}),e.jsx(ue,{value:"path",children:e.jsx(q,{className:`${g?"h-[75vh]":"h-[22vh]"} lg:h-[48vh] overflow-hidden`,children:e.jsx(fe,{form:i,sourceKeys:h,type:"paths",label:"Path"})})})]})})})]}),e.jsxs(le,{children:[e.jsx("h1",{className:"text-2xl font-semibold text-center",children:"Dependencies"}),e.jsx("p",{className:"text-center italic",children:"Select here what rules and versions you want your character to include. You can also select homebrew you have imported."}),e.jsxs(i.AppForm,{children:[e.jsx(ss,{form:i}),e.jsx(as,{form:i})]}),e.jsxs("div",{className:"flex gap-2 w-full self-end justify-end mt-4",children:[e.jsxs(at,{children:[e.jsx(nt,{asChild:!0,children:e.jsx(ae,{variant:"destructive",children:"Cancel"})}),e.jsxs(it,{children:[e.jsxs(ot,{children:[e.jsx(lt,{children:"Are you absolutely sure?"}),e.jsx(dt,{children:"This action cannot be undone. This will permanently delete your character creation progress and return you to the characters list."})]}),e.jsxs(ct,{children:[e.jsx(ut,{children:"Cancel"}),e.jsx(ht,{onClick:()=>r({to:"/characters"}),children:"Continue"})]})]})]}),e.jsx(ae,{type:"submit",form:"create-character",children:"Create"})]})]})]})]})})}export{ms as component};
